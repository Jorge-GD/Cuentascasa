# üöÄ Sistema de Cache Redis para Gastos Casa

## üéØ **EL PROBLEMA QUE VAMOS A RESOLVER**

**Situaci√≥n actual:**
- Dashboard tarda 2-3 segundos en cargar
- Cada vez que abres la app, calcula TODO desde cero
- Consultas complejas se ejecutan una y otra vez
- Base de datos trabaja al 100% innecesariamente

**Despu√©s de Redis:**
- Dashboard carga en 0.2-0.5 segundos
- Datos se calculan una vez, se sirven mil veces
- Base de datos descansa mientras Redis trabaja
- Escalabilidad para toda la familia

---

## üèóÔ∏è **ARQUITECTURA COMPLETA DEL SISTEMA**

### **1. Niveles de Cache (Por Prioridad)**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    NIVEL 1: DATOS EST√ÅTICOS                 ‚îÇ
‚îÇ  TTL: 1-24 horas | Raramente cambian | Acceso frecuente     ‚îÇ
‚îÇ  ‚Ä¢ Categor√≠as y subcategor√≠as                               ‚îÇ
‚îÇ  ‚Ä¢ Informaci√≥n de cuentas                                   ‚îÇ
‚îÇ  ‚Ä¢ Reglas de categorizaci√≥n                                 ‚îÇ
‚îÇ  ‚Ä¢ Configuraci√≥n de usuario                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   NIVEL 2: M√âTRICAS DASHBOARD               ‚îÇ
‚îÇ  TTL: 15-30 minutos | C√°lculos pesados | Acceso constante   ‚îÇ
‚îÇ  ‚Ä¢ Totales de gastos/ingresos por mes                       ‚îÇ
‚îÇ  ‚Ä¢ An√°lisis por categor√≠as                                  ‚îÇ
‚îÇ  ‚Ä¢ Estado de presupuestos                                   ‚îÇ
‚îÇ  ‚Ä¢ M√©tricas de cuentas individuales                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   NIVEL 3: AN√ÅLISIS COMPLEJOS               ‚îÇ
‚îÇ  TTL: 1-2 horas | ML/IA | Procesamiento intensivo          ‚îÇ
‚îÇ  ‚Ä¢ Tendencias temporales                                    ‚îÇ
‚îÇ  ‚Ä¢ An√°lisis 50/30/20                                        ‚îÇ
‚îÇ  ‚Ä¢ Comparativas entre cuentas                               ‚îÇ
‚îÇ  ‚Ä¢ Proyecciones futuras                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **2. Estructura de Keys Redis**

```javascript
// NIVEL 1: Datos est√°ticos
"cache:categories:all"                    // Todas las categor√≠as
"cache:accounts:all"                      // Todas las cuentas
"cache:rules:${cuentaId}"                // Reglas por cuenta
"cache:config:user:${userId}"            // Configuraci√≥n usuario

// NIVEL 2: M√©tricas Dashboard
"cache:dashboard:${cuentaId}:${year}:${month}"     // M√©tricas principales
"cache:categories:${cuentaId}:${year}:${month}"    // Breakdown categor√≠as
"cache:budget:${cuentaId}:${year}:${month}"        // Estado presupuestos

// NIVEL 3: An√°lisis complejos
"cache:trends:${cuentaId}:${months}"               // Tendencias
"cache:plan503020:${cuentaIds}:${year}:${month}"   // An√°lisis 50/30/20
"cache:comparison:${cuentaIds}:${period}"          // Comparativas
```

---

## üíª **IMPLEMENTACI√ìN T√âCNICA PASO A PASO**

### **Paso 1: Configuraci√≥n Redis**

```javascript
// lib/redis/client.ts
import { createClient } from 'redis';

class RedisClient {
  private static instance: RedisClient;
  private client: any;
  
  private constructor() {
    this.client = createClient({
      url: process.env.REDIS_URL || 'redis://localhost:6379',
      // Para red local casa
      socket: {
        host: process.env.REDIS_HOST || 'localhost',
        port: parseInt(process.env.REDIS_PORT || '6379')
      }
    });
    
    this.client.on('error', (err) => {
      console.error('Redis Client Error', err);
    });
    
    this.client.on('connect', () => {
      console.log('‚úÖ Redis conectado correctamente');
    });
  }

  public static getInstance(): RedisClient {
    if (!RedisClient.instance) {
      RedisClient.instance = new RedisClient();
    }
    return RedisClient.instance;
  }

  async connect() {
    if (!this.client.isOpen) {
      await this.client.connect();
    }
  }

  async disconnect() {
    if (this.client.isOpen) {
      await this.client.disconnect();
    }
  }

  getClient() {
    return this.client;
  }
}

export default RedisClient;
```

### **Paso 2: Sistema de Cache Inteligente**

```javascript
// lib/redis/cache-manager.ts
import RedisClient from './client';

export class CacheManager {
  private redis: any;
  
  constructor() {
    this.redis = RedisClient.getInstance().getClient();
  }

  // M√©todo gen√©rico para obtener/establecer cache
  async getOrSet<T>(
    key: string,
    fetchFunction: () => Promise<T>,
    ttl: number = 1800 // 30 minutos por defecto
  ): Promise<T> {
    try {
      // Intentar obtener del cache
      const cached = await this.redis.get(key);
      
      if (cached) {
        console.log(`üöÄ Cache HIT para ${key}`);
        return JSON.parse(cached);
      }
      
      // Si no est√° en cache, ejecutar funci√≥n y cachear
      console.log(`üìä Cache MISS para ${key} - Calculando...`);
      const data = await fetchFunction();
      
      // Guardar en cache
      await this.redis.setEx(key, ttl, JSON.stringify(data));
      
      return data;
    } catch (error) {
      console.error(`‚ùå Error en cache para ${key}:`, error);
      // Si falla Redis, ejecutar funci√≥n directamente
      return await fetchFunction();
    }
  }

  // Invalidar cache por patr√≥n
  async invalidatePattern(pattern: string): Promise<void> {
    try {
      const keys = await this.redis.keys(pattern);
      if (keys.length > 0) {
        await this.redis.del(keys);
        console.log(`üóëÔ∏è Invalidados ${keys.length} caches para patr√≥n: ${pattern}`);
      }
    } catch (error) {
      console.error(`‚ùå Error invalidando patr√≥n ${pattern}:`, error);
    }
  }

  // Cache espec√≠fico para datos est√°ticos
  async getCategoriesCache(): Promise<any> {
    return this.getOrSet(
      'cache:categories:all',
      async () => {
        const { prisma } = await import('../db/prisma');
        return await prisma.categoria.findMany({
          include: { subcategorias: true }
        });
      },
      3600 // 1 hora
    );
  }

  // Cache espec√≠fico para dashboard
  async getDashboardCache(cuentaId: string, year: number, month: number): Promise<any> {
    return this.getOrSet(
      `cache:dashboard:${cuentaId}:${year}:${month}`,
      async () => {
        const { calculateDashboardMetrics } = await import('../analytics/calculations');
        return await calculateDashboardMetrics(cuentaId, year, month);
      },
      1800 // 30 minutos
    );
  }

  // Cache espec√≠fico para Plan 50/30/20
  async getPlan503020Cache(cuentaIds: string[], year: number, month: number): Promise<any> {
    const cacheKey = `cache:plan503020:${cuentaIds.join(',')}:${year}:${month}`;
    return this.getOrSet(
      cacheKey,
      async () => {
        const { calculatePlan503020 } = await import('../utils/plan503020');
        return await calculatePlan503020(cuentaIds, year, month);
      },
      3600 // 1 hora
    );
  }
}

export const cacheManager = new CacheManager();
```

### **Paso 3: Integraci√≥n en APIs**

```javascript
// app/api/analytics/dashboard/route.ts
import { cacheManager } from '@/lib/redis/cache-manager';

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const cuentaId = searchParams.get('cuentaId');
    const year = parseInt(searchParams.get('year') || new Date().getFullYear().toString());
    const month = parseInt(searchParams.get('month') || (new Date().getMonth() + 1).toString());

    if (!cuentaId) {
      return Response.json({ error: 'cuentaId requerido' }, { status: 400 });
    }

    // üöÄ AQU√ç ES LA MAGIA - Una l√≠nea cambia todo
    const dashboardData = await cacheManager.getDashboardCache(cuentaId, year, month);

    return Response.json(dashboardData);
  } catch (error) {
    console.error('Error en dashboard API:', error);
    return Response.json({ error: 'Error interno del servidor' }, { status: 500 });
  }
}
```

### **Paso 4: Sistema de Invalidaci√≥n Inteligente**

```javascript
// lib/redis/invalidation.ts
import { cacheManager } from './cache-manager';

export class CacheInvalidator {
  
  // Cuando se crea/actualiza un movimiento
  async invalidateMovementCaches(cuentaId: string, fecha: Date): Promise<void> {
    const year = fecha.getFullYear();
    const month = fecha.getMonth() + 1;
    
    // Invalidar caches relacionados
    await Promise.all([
      cacheManager.invalidatePattern(`cache:dashboard:${cuentaId}:${year}:${month}`),
      cacheManager.invalidatePattern(`cache:categories:${cuentaId}:${year}:${month}`),
      cacheManager.invalidatePattern(`cache:budget:${cuentaId}:${year}:${month}`),
      cacheManager.invalidatePattern(`cache:plan503020:*${cuentaId}*:${year}:${month}`),
      cacheManager.invalidatePattern(`cache:trends:${cuentaId}:*`)
    ]);
    
    console.log(`üîÑ Caches invalidados para cuenta ${cuentaId} en ${year}/${month}`);
  }

  // Cuando se actualiza una categor√≠a
  async invalidateCategoryCaches(): Promise<void> {
    await Promise.all([
      cacheManager.invalidatePattern('cache:categories:*'),
      cacheManager.invalidatePattern('cache:dashboard:*'),
      cacheManager.invalidatePattern('cache:budget:*')
    ]);
    
    console.log('üîÑ Caches de categor√≠as invalidados');
  }

  // Cuando se actualiza una cuenta
  async invalidateAccountCaches(cuentaId: string): Promise<void> {
    await Promise.all([
      cacheManager.invalidatePattern('cache:accounts:*'),
      cacheManager.invalidatePattern(`cache:dashboard:${cuentaId}:*`),
      cacheManager.invalidatePattern(`cache:*:${cuentaId}:*`)
    ]);
    
    console.log(`üîÑ Caches invalidados para cuenta ${cuentaId}`);
  }
}

export const cacheInvalidator = new CacheInvalidator();
```

---

## üéØ **INTEGRACI√ìN EN TU APLICACI√ìN ACTUAL**

### **1. Modificar API de Movimientos**

```javascript
// app/api/movimientos/route.ts
import { cacheInvalidator } from '@/lib/redis/invalidation';

export async function POST(request: Request) {
  try {
    const body = await request.json();
    
    // Crear movimiento (c√≥digo actual)
    const movimiento = await prisma.movimiento.create({
      data: body
    });
    
    // üöÄ NUEVA L√çNEA - Invalidar cache
    await cacheInvalidator.invalidateMovementCaches(
      movimiento.cuentaId, 
      new Date(movimiento.fecha)
    );
    
    return Response.json(movimiento);
  } catch (error) {
    // ... manejo de errores
  }
}
```

### **2. Modificar Componentes Dashboard**

```javascript
// components/dashboard/metric-card.tsx
import { useEffect, useState } from 'react';

export function MetricCard({ cuentaId, year, month }) {
  const [metrics, setMetrics] = useState(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    const fetchMetrics = async () => {
      setLoading(true);
      
      // üöÄ Esta llamada ahora usa cache Redis
      const response = await fetch(
        `/api/analytics/dashboard?cuentaId=${cuentaId}&year=${year}&month=${month}`
      );
      
      const data = await response.json();
      setMetrics(data);
      setLoading(false);
    };
    
    fetchMetrics();
  }, [cuentaId, year, month]);
  
  if (loading) {
    return <div>Cargando m√©tricas...</div>; // Esto ser√° s√∫per r√°pido
  }
  
  return (
    <div className="metric-card">
      <h3>Gastos Totales</h3>
      <p className="text-2xl font-bold">{metrics.totalGastos}‚Ç¨</p>
      <p className="text-sm text-gray-500">üìä Datos desde cache</p>
    </div>
  );
}
```

---

## üìä **IMPACTO EN RENDIMIENTO**

### **Antes de Redis:**
```
Dashboard load: 2-3 segundos
‚îú‚îÄ‚îÄ Query categor√≠as: 300ms
‚îú‚îÄ‚îÄ Query movimientos: 800ms
‚îú‚îÄ‚îÄ C√°lculos aggregados: 1200ms
‚îú‚îÄ‚îÄ Query presupuestos: 400ms
‚îî‚îÄ‚îÄ Renderizado: 300ms

Database CPU: 70-80%
Consultas/minuto: 50-100
```

### **Despu√©s de Redis:**
```
Dashboard load: 0.2-0.5 segundos
‚îú‚îÄ‚îÄ Cache categor√≠as: 5ms
‚îú‚îÄ‚îÄ Cache movimientos: 10ms
‚îú‚îÄ‚îÄ Cache m√©tricas: 15ms
‚îú‚îÄ‚îÄ Cache presupuestos: 8ms
‚îî‚îÄ‚îÄ Renderizado: 150ms

Database CPU: 10-20%
Consultas/minuto: 5-10
```

### **Mejoras Espec√≠ficas:**
- **Dashboard**: 83% m√°s r√°pido
- **An√°lisis categor√≠as**: 90% m√°s r√°pido
- **Plan 50/30/20**: 75% m√°s r√°pido
- **Carga base datos**: 80% menos queries

---

## üîß **CONFIGURACI√ìN PARA TU CASA**

### **1. Docker Compose (Recomendado)**

```yaml
# docker-compose.yml
version: '3.8'
services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    networks:
      - casa-network

  gastos-casa:
    # tu aplicaci√≥n actual
    depends_on:
      - redis
    environment:
      - REDIS_URL=redis://redis:6379
    networks:
      - casa-network

volumes:
  redis_data:

networks:
  casa-network:
    driver: bridge
```

### **2. Variables de Entorno**

```bash
# .env.local
REDIS_URL=redis://localhost:6379
REDIS_HOST=localhost
REDIS_PORT=6379
```

### **3. Instalaci√≥n de Dependencias**

```bash
npm install redis
npm install @types/redis --save-dev
```

---

## üöÄ **PLAN DE IMPLEMENTACI√ìN**

### **Semana 1: Configuraci√≥n Base**
- [ ] Instalar Redis y dependencias
- [ ] Configurar cliente Redis
- [ ] Crear CacheManager b√°sico
- [ ] Testear conexi√≥n

### **Semana 2: Cache Nivel 1 (Datos Est√°ticos)**
- [ ] Cachear categor√≠as
- [ ] Cachear cuentas
- [ ] Cachear reglas
- [ ] Medir mejoras

### **Semana 3: Cache Nivel 2 (Dashboard)**
- [ ] Cache m√©tricas dashboard
- [ ] Cache an√°lisis categor√≠as
- [ ] Sistema de invalidaci√≥n
- [ ] Tests de rendimiento

### **Semana 4: Cache Nivel 3 (An√°lisis Complejos)**
- [ ] Cache Plan 50/30/20
- [ ] Cache tendencias
- [ ] Cache comparativas
- [ ] Optimizaci√≥n final

---

## üéØ **RESULTADO FINAL**

**Tu aplicaci√≥n pasar√° de:**
- "Espera que cargue..." (frustrante)
- Dashboard lento y pesado
- Base de datos trabajando 24/7

**A:**
- "¬°Wow, qu√© r√°pido!" (satisfactorio)
- Dashboard instant√°neo
- Base de datos relajada
- Escalabilidad para toda la familia

**En n√∫meros:**
- ‚ö° 83% m√°s r√°pido
- üîã 80% menos carga DB
- üöÄ 10x m√°s escalable
- üí∞ Cero costo adicional (Redis gratis)

Esta implementaci√≥n convertir√° tu aplicaci√≥n de gastos en una herramienta s√∫per r√°pida y eficiente. ¬°Es como ponerle un motor turbo a tu coche!